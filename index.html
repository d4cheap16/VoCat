<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VoCAT</title>
    <!-- 預載資源以提升速度 -->
    <link rel="preload" as="image" href="https://d4cheap16.github.io/VoCat/GB01.png">
    <link rel="preload" as="image" href="https://d4cheap16.github.io/VoCat/Cat.jpg">
    
    <!-- 社群分享設定 (Open Graph) -->
    <meta name="description" content="Learn high school vocabulary in a fun way!">
    <meta property="og:title" content="VoCat"><meta property="og:description" content="Learn high school vocabulary in a fun way!">
    <meta property="og:image" content="https://d4cheap16.github.io/VoCat/GB.jpg"><meta property="og:url" content="https://d4cheap16.github.io/VoCat/">
    <meta property="og:type" content="website">

    <!-- 網站圖示 -->
    <link rel="icon" href="https://d4cheap16.github.io/VoCat/favicon.png" type="image/jpeg">
    <link rel="apple-touch-icon" href="https://d4cheap16.github.io/VoCat/favicon.png">

    <!-- 字體設定 -->
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /* --- 全域變數與主題設定 --- */
        :root { --screen-bg: #9bbc0f; --screen-text: #0f380f; --screen-overlay: rgba(155, 188, 15, 0.75); --body-bg: #d3d3d3; }
        body.palette-pocket { --screen-bg: #333333; --screen-text: #f0f0f0; --screen-overlay: rgba(51, 51, 51, 0.85); }
        body.palette-sepia { --screen-bg: #d0e0f0; --screen-text: #2c3e50; --screen-overlay: rgba(208, 224, 240, 0.75); }

        /* --- 基礎版面設定 --- */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: var(--body-bg); font-family: 'Press Start 2P', 'Noto Sans TC', cursive, sans-serif; touch-action: none; /* 禁止手機預設手勢 */ }
        .container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
        
        /* --- Gameboy 機身與螢幕 --- */
        .gameboy-wrapper { position: relative; max-width: 450px; width: 100%; aspect-ratio: 1000 / 1602; display: flex; justify-content: center; align-items: center; -webkit-touch-callout: none; user-select: none; }
        .gameboy-image { display: block; width: 100%; height: 100%; pointer-events: none; }
        .gameboy-screen { position: absolute; top: 10%; left: 11%; width: 78%; height: 36%; background-color: var(--screen-bg); color: var(--screen-text); box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; clip-path: inset(0 round 9px 9px 18% 9px); }
        
        /* --- 開機動畫 --- */
        .boot-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 100; display: flex; justify-content: center; align-items: center; animation: fadeOutBoot 1s ease-in 1.5s forwards; }
        .boot-logo { opacity: 0; animation: dropInLogo 1.5s ease-out 0.5s forwards, blinkLogo 0.8s step-end 2.5s; }
        .boot-screen.reboot { display: flex !important; opacity: 1; animation: fadeOutBoot 1s ease-in 1.5s forwards; }
        .boot-screen.reboot .boot-logo { opacity: 0; animation: dropInLogo 1.5s ease-out 0.5s forwards, blinkLogo 0.8s step-end 2.5s; }
        .boot-logo img { width: 100%; height: auto; }
        @keyframes dropInLogo { 0% { transform: translateY(-100%); opacity: 1; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes blinkLogo { 50% { opacity: 0; } }
        @keyframes fadeOutBoot { to { opacity: 0; visibility: hidden; } }
        
        /* --- 選單系統 --- */
        .main-menu { opacity: 0; animation: fadeInMenu 0.5s ease-in 2.5s forwards; height: 100%; display: flex; flex-direction: column; padding: 3%; box-sizing: border-box; }
        .main-menu.reboot { opacity: 0; animation: fadeInMenu 0.5s ease-in 2.5s forwards; }
        @keyframes fadeInMenu { to { opacity: 1; } }
        .tester-menu { display: none; height: 100%; flex-direction: column; padding: 3%; box-sizing: border-box; }
        .gameboy-screen.tester-active .main-menu { display: none; }
        .gameboy-screen.tester-active .tester-menu { display: flex; }
        
        .screen-header { display: flex; justify-content: center; align-items: center; gap: 8px; padding-bottom: 2%; border-bottom: 2px solid var(--screen-text); margin-bottom: 3%; font-size: clamp(10px, 3vw, 14px); letter-spacing: -1px; flex-shrink: 0; }
        .header-cat { height: 2em; width: auto; }
        .menu-wrapper { overflow-y: auto; flex-grow: 1; scrollbar-width: none; }
        .menu-wrapper::-webkit-scrollbar { width: 0px; background: transparent; }
        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-list li { margin-bottom: 2%; }
        .menu-list a { color: var(--screen-text); text-decoration: none; display: flex; align-items: center; padding: 2.5%; font-size: clamp(14px, 3.8vw, 16px); transition: all 0.2s; white-space: nowrap; }
        .menu-category > a { font-weight: bold; justify-content: space-between; }
        .menu-category > a::after { content: '▼'; font-size: 80%; transition: transform 0.2s; }
        .menu-category.open > a::after { transform: rotate(180deg); }
        .sub-menu { list-style: none; padding-left: 10px; margin: 5px 0; display: none; }
        .menu-category.open .sub-menu { display: block; }
        .sub-menu a { font-size: clamp(12px, 3.5vw, 14px); }
        .sub-menu a::before, .tester-menu .menu-list a::before { content: '▶'; margin-right: 8%; opacity: 0; transition: opacity 0.2s; }
        .menu-list a:hover, .menu-list a:focus, .menu-list a.selected { background-color: var(--screen-text); color: var(--screen-bg); }
        .sub-menu a:hover::before, .sub-menu a:focus::before, .tester-menu .menu-list a:hover::before, .tester-menu .menu-list a.selected::before { opacity: 1; }
        .menu-footer { flex-shrink: 0; text-align: center; padding: 4% 0 2%; margin-top: auto; border-top: 2px solid var(--screen-text); font-size: clamp(9px, 2.5vw, 11px); letter-spacing: -1px; }
        .menu-footer p { margin: 0; }

        /* --- 遊戲畫面 --- */
        #game-canvas { display: none; width: 100%; height: 100%; background-color: var(--screen-bg); }
        #game-score { display: none; position: absolute; top: 4px; left: 12px; right: 12px; font-size: clamp(10px, 2.5vw, 11px); color: var(--screen-text); z-index: 10; white-space: pre; text-align: right; line-height: 1.2; font-family: 'Press Start 2P', cursive; }
        .gameboy-screen.game-active .main-menu, .gameboy-screen.game-active .tester-menu { display: none; }
        .gameboy-screen.game-active #game-canvas, .gameboy-screen.game-active #game-score { display: block; }
        /* 復古網格濾鏡 */
        .gameboy-screen.game-active::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(15, 56, 15, 0.07) 1px, rgba(15, 56, 15, 0.07) 2px), repeating-linear-gradient(90deg, transparent, transparent 1px, rgba(15, 56, 15, 0.07) 1px, rgba(15, 56, 15, 0.07) 2px); background-size: 2px 2px; pointer-events: none; z-index: 5; }

        .screen-footer { margin: 0; padding: 0; position: absolute; bottom: 46%; left: 11%; width: 80%; text-align: left; font-size: clamp(9px, 2.2vw, 11px); color: #444; opacity: 0; line-height: 1.6; cursor: pointer; }
        .screen-footer.animate { animation: fadeInMenu 0.5s ease-in 0s forwards; }
        .screen-footer p { margin: 0; padding: 0; }
        .site-footer { position: absolute; bottom: 10px; left: 0; width: 100%; display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 6px; font-size: 10px; color: #555; z-index: 10; }
        .site-footer span { display: inline-flex; align-items: center; }
        @media (max-width: 380px) { .site-footer { flex-direction: column; gap: 2px; } }
        .footer-logo { height: 2em; width: auto; margin-left: 4px; vertical-align: middle; }

        /* --- 按鍵樣式 (優化陰影與手感) --- */
        .gb-button { 
            position: absolute; 
            z-index: 50; 
            transition: transform 0.05s, background-color 0.1s, box-shadow 0.1s;
            /* 初始狀態給予外部陰影，增加立體凸出感 */
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); 
        }
        /* 擴大隱形點擊區域，提升手機操作成功率 */
        .gb-button::after { content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px; border-radius: inherit; }
        .gb-button:hover { background-color: rgba(0, 0, 0, 0.1); cursor: pointer; }
        
        /* 按下狀態：位移加深，內陰影加重，製造深坑感 */
        .gb-button:active {
            transform: translate(3px, 3px); /* 從 2px 增加到 3px */
            background-color: rgba(0, 0, 0, 0.25);
            box-shadow: inset 5px 5px 10px rgba(0,0,0,0.75); /* 加深內陰影 */
        }

        /* 按鍵形狀與位置微調 */
        #btn-a, #btn-b { border-radius: 50%; }
        #btn-select, #btn-start { border-radius: 25px; }
        #btn-up, #btn-down, #btn-left, #btn-right { border-radius: 2px; }
        #btn-up::after, #btn-down::after, #btn-left::after, #btn-right::after { top: -8px; left: -8px; right: -8px; bottom: -8px; }

        #btn-a { top: 59.5%; left: 78.5%; width: 15%; height: 10%; }
        #btn-b { top: 63.5%; left: 61.5%; width: 15%; height: 10%; }
        #btn-select { top: 80%; left: 29%; width: 14%; height: 4%; }
        #btn-start { top: 80%; left: 46%; width: 14%; height: 4%; }
        #btn-up { top: 59.5%; left: 15.5%; width: 10%; height: 7%; }
        #btn-down { top: 69.5%; left: 15.5%; width: 10%; height: 7%; }
        #btn-left { top: 64.5%; left: 7.5%; width: 10%; height: 7%; }
        #btn-right { top: 64.5%; left: 24.5%; width: 10%; height: 7%; }

        /* --- 彈出視窗 --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 200; padding: 15px; box-sizing: border-box; }
        .modal-overlay.show { display: flex; }
        .modal-content { background-color: var(--screen-bg); color: var(--screen-text); border: 3px solid var(--screen-text); padding: 15px; max-width: 95%; width: 500px; border-radius: 8px; font-family: 'Press Start 2P', 'Noto Sans TC', sans-serif; line-height: 1.7; font-size: clamp(14px, 3.5vw, 16px); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--screen-text); margin-bottom: 15px; padding-bottom: 10px; font-family: 'Press Start 2P', cursive; }
        .modal-header p { margin: 0; font-size: clamp(15px, 4vw, 18px); }
        .modal-close-btn { background-color: var(--screen-text); color: var(--screen-bg); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-family: sans-serif; font-weight: bold; font-size: 16px; display: flex; justify-content: center; align-items: center; transition: transform 0.1s; }
        .modal-close-btn:active { transform: scale(0.9); }
        .modal-body p { margin: 0 0 1em 0; } .modal-body p:last-child { margin-bottom: 0; }
        .scores-list { padding: 0; margin: 0; list-style: none; }
        .scores-list li { display: flex; justify-content: space-between; margin-bottom: 0.8em; font-family: 'Press Start 2P', cursive; font-size: clamp(12px, 3vw, 14px); }
        .scores-list li span:last-child { text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <div class="gameboy-wrapper">
            <img src="https://d4cheap16.github.io/VoCat/GB01.png" alt="Game Boy background" class="gameboy-image">
            <div class="gameboy-screen">
                <div class="boot-screen"><div class="boot-logo"><img src="https://d4cheap16.github.io/VoCat/Cat.jpg" alt="開機貓貓"></div></div>
                
                <!-- 主選單結構 -->
                <div class="main-menu">
                    <div class="screen-header">
                        <img src="https://d4cheap16.github.io/VoCat/CatL.png" class="header-cat"><p>VoCAT</p><img src="https://d4cheap16.github.io/VoCat/CatR.png" class="header-cat">
                    </div>
                    <div class="menu-wrapper">
                        <ul class="menu-list">
                            <li class="menu-category"><a href="#">課文單字</a>
                                <ul class="sub-menu">
                                    <li><a href="book1.html" target="_self">Book 1</a></li><li><a href="book2.html" target="_self">Book 2</a></li><li><a href="book3.html" target="_self">Book 3</a></li><li><a href="book4.html" target="_self">Book 4</a></li><li><a href="book5.html" target="_self">Book 5</a></li>
                                </ul>
                            </li>
                            <li class="menu-category"><a href="#">高頻單字</a>
                                <ul class="sub-menu">
                                    <li><a href="high_freq1.html" target="_self">UNIT 01-04</a></li><li><a href="https://forms.gle/bXUNRobFD1P8MYmx7" target="_blank">高一上二段</a></li><li><a href="https://forms.gle/oDeaR87M4xSkaixE6" target="_blank">高一上一段</a></li><li><a href="high_freq2.html" target="_self">UNIT 05-09</a></li><li><a href="https://forms.gle/yemp2H1DgrvQAJdm6" target="_blank">高一上期末</a></li><li><a href="high_freq3.html" target="_self">UNIT 10-14</a></li><li><a href="high_freq4.html" target="_self">UNIT 15-18</a></li>
                                </ul>
                            </li>
                            <li class="menu-category"><a href="#">文法練習</a>
                                <ul class="sub-menu">
                                    <li><a href="https://forms.gle/8oyr4yGRaesG1rLq7" target="_blank">高一上二段</a></li><li><a href="https://forms.gle/oATJaYcsVUHRbP2d7" target="_blank">高二上二段</a></li><li><a href="https://forms.gle/CTdXFpa7mmCZS2pK7" target="_blank">高一上一段</a></li><li><a href="https://forms.gle/zxU34XhghWkukZrz8" target="_blank">高二上一段</a></li>
                                </ul>
                            </li>
                            <li class="menu-category"><a href="#">OPTIONS</a>
                                <ul class="sub-menu">
                                    <!-- 已移除震動開關 -->
                                    <li><a href="#" id="palette-switch-link">CHANGE THEME</a></li><li><a href="#" id="design-concept-link">DESIGN CONCEPT</a></li><li><a href="https://forms.gle/iWMy29gJDsgCWr837" target="_blank">CONTACT ME</a></li><li><a href="#" id="high-scores-link">HIGH SCORES</a></li><li><a href="#" id="clear-data-link">CLEAR SCORES</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- 遊戲測試選單 -->
                <div class="tester-menu">
                    <div class="screen-header"><p>GAME SELECT</p></div>
                    <div class="menu-wrapper">
                        <ul class="menu-list"><li><a href="#" data-game="back">MAIN MENU</a></li><li><a href="#" data-game="ghostbuster">GHOSTBUSTER</a></li><li><a href="#" data-game="pacman">PAC-MAN RUN</a></li><li><a href="#" data-game="snake">SNAKE</a></li><li><a href="#" data-game="tetris">TETRIS</a></li></ul>
                    </div>
                    <div class="menu-footer"><p>A: PLAY • UP/DOWN: SELECT</p></div>
                </div>
                
                <canvas id="game-canvas"></canvas><div id="game-score"></div>
            </div>
            
            <div class="screen-footer"><p id="quote-text">Loading quote...</p></div>
            
            <!-- 實體按鍵 -->
            <a href="#" id="btn-a" class="gb-button" data-key="A"></a><a href="#" id="btn-b" class="gb-button" data-key="B"></a>
            <a href="#" id="btn-select" class="gb-button" data-key="Select"></a><a href="#" id="btn-start" class="gb-button" data-key="Start"></a>
            <a href="#" id="btn-up" class="gb-button" data-key="Up"></a><a href="#" id="btn-down" class="gb-button" data-key="Down"></a><a href="#" id="btn-left" class="gb-button" data-key="Left"></a><a href="#" id="btn-right" class="gb-button" data-key="Right"></a>
        </div>
    </div>
    
    <!-- 音效 (壓縮為單行) -->
    <audio id="audio-open" src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQgAADD/38Agf9/AP//fwB/AP//f/9/AP8A//9/AIAA/wB//38AgAA="></audio>
    <audio id="audio-select" src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQgAAAAgP9/AP8AgAD/AIAA/wCAAP8AgAD/AIAA/wCAAP8AgAD/AIAA/wCAAP8A"></audio>

    <!-- 彈出視窗 HTML -->
    <div id="about-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><p>DESIGN CONCEPT</p><button id="close-modal-btn" class="modal-close-btn">X</button></div><div class="modal-body"></div></div></div>
    <div id="high-scores-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><p>HIGH SCORES</p><button id="close-scores-btn" class="modal-close-btn">X</button></div><div class="modal-body"><ul class="scores-list"></ul></div></div></div>

    <script>
        window.addEventListener('contextmenu', e => e.preventDefault()); // 禁止右鍵

        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素快取
            const audioOpen = document.getElementById('audio-open'), audioSelect = document.getElementById('audio-select');
            const gameboyScreen = document.querySelector('.gameboy-screen'), bootScreen = document.querySelector('.boot-screen'), mainMenu = document.querySelector('.main-menu');
            const screenFooter = document.querySelector('.screen-footer'), quoteElement = document.getElementById('quote-text');
            const modals = { about: document.getElementById('about-modal'), scores: document.getElementById('high-scores-modal') };
            
            // 初始化格言與動畫
            const quotes = ["Try: UP UP DOWN DOWN LEFT RIGHT LEFT RIGHT B A START", "Every expert was once a beginner.", "Don't stop until you're proud.", "The harder you work, the luckier you get.", "Success is the sum of small efforts.", "It always seems impossible until it's done.", "Mistakes are proof that you are trying.", "Turn 'I wish' into 'I will'.", "Learn something new every day.", "No one can take what you've learned away from you.", "Strive for progress, not perfection.", "Be awesome today."];
            quoteElement.textContent = quotes[Math.floor(Math.random() * quotes.length)];
            screenFooter.classList.add('animate');
            modals.about.querySelector('.modal-body').innerHTML = `<p>WELCOME!</p><p>用懷舊的感覺，讓學習也有趣一點。</p><p>網站還有小彩蛋，可以一起體驗我的童年！</p>`;

            // --- 事件監聽器管理 ---
            const playSound = (audio) => { audio.currentTime = 0; audio.play(); };
            const closeModal = () => { playSound(audioSelect); Object.values(modals).forEach(m => m.classList.remove('show')); };
            
            document.getElementById('design-concept-link').addEventListener('click', (e) => { e.preventDefault(); playSound(audioOpen); modals.about.classList.add('show'); });
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('close-scores-btn').addEventListener('click', closeModal);
            Object.values(modals).forEach(m => m.addEventListener('click', e => { if(e.target === m) closeModal(); }));
            
            screenFooter.addEventListener('click', () => { playSound(audioSelect); quoteElement.textContent = quotes[Math.floor(Math.random() * quotes.length)]; });

            // 高分榜邏輯
            document.getElementById('high-scores-link').addEventListener('click', (e) => {
                e.preventDefault(); playSound(audioOpen);
                const list = modals.scores.querySelector('.scores-list'); list.innerHTML = '';
                [{n:'GHOSTBUSTER',k:'ghostbusterHighScore'}, {n:'PAC-MAN RUN',k:'pacmanClassicRunHighScore'}, {n:'SNAKE',k:'snakeHighScore'}, {n:'TETRIS',k:'tetrisHighScore'}]
                .forEach(g => list.innerHTML += `<li><span>${g.n}</span><span>${String(Math.floor(localStorage.getItem(g.k)||0)).padStart(5,'0')}</span></li>`);
                modals.scores.classList.add('show');
            });

            // 清除資料
            document.getElementById('clear-data-link').addEventListener('click', (e) => {
                e.preventDefault(); playSound(audioOpen);
                showCustomConfirm('Are you sure you want to clear all high scores?', () => {
                    ['pacmanClassicRunHighScore', 'ghostbusterHighScore', 'snakeHighScore', 'tetrisHighScore'].forEach(k => localStorage.removeItem(k));
                    showCustomAlert('All high scores have been cleared!');
                });
            });

            // 主題切換
            const palettes = ['', 'palette-pocket', 'palette-sepia'];
            let paletteIdx = palettes.indexOf(localStorage.getItem('vocatPalette') || '');
            if (paletteIdx > 0) document.body.className = palettes[paletteIdx];
            document.getElementById('palette-switch-link').addEventListener('click', (e) => {
                e.preventDefault(); playSound(audioSelect);
                paletteIdx = (paletteIdx + 1) % palettes.length;
                document.body.className = palettes[paletteIdx]; localStorage.setItem('vocatPalette', palettes[paletteIdx]);
            });

            // 自訂 Alert/Confirm 輔助函式
            function showCustomAlert(msg) {
                const m = document.createElement('div'); m.className='modal-overlay show';
                m.innerHTML=`<div class="modal-content"><div class="modal-header"><p>NOTICE</p></div><div class="modal-body" style="text-align:center;padding:20px 0;"><p>${msg}</p><button id="alert-ok" style="padding:8px 16px;margin-top:20px;font-family:'Press Start 2P';border:2px solid var(--screen-text);background:var(--screen-text);color:var(--screen-bg);cursor:pointer;">OK</button></div></div>`;
                document.body.appendChild(m); document.getElementById('alert-ok').onclick=()=>{playSound(audioSelect); m.remove();};
            }
            function showCustomConfirm(msg, cb) {
                const m = document.createElement('div'); m.className='modal-overlay show';
                m.innerHTML=`<div class="modal-content"><div class="modal-header"><p>CONFIRM</p></div><div class="modal-body" style="text-align:center;padding:20px 0;"><p>${msg}</p><div style="margin-top:20px;"><button id="confirm-yes" style="padding:8px 16px;margin-right:10px;font-family:'Press Start 2P';border:2px solid var(--screen-text);background:var(--screen-text);color:var(--screen-bg);cursor:pointer;">YES</button><button id="confirm-no" style="padding:8px 16px;font-family:'Press Start 2P';border:2px solid var(--screen-text);background:transparent;color:var(--screen-text);cursor:pointer;">NO</button></div></div></div>`;
                document.body.appendChild(m);
                document.getElementById('confirm-yes').onclick=()=>{playSound(audioSelect); cb(); m.remove();}; document.getElementById('confirm-no').onclick=()=>{playSound(audioSelect); m.remove();};
            }

            // 選單摺疊邏輯
            document.querySelectorAll('.menu-category > a').forEach(c => c.addEventListener('click', function(e) {
                e.preventDefault(); playSound(audioOpen);
                const p = this.parentElement, wasOpen = p.classList.contains('open');
                document.querySelectorAll('.menu-category.open').forEach(x => x.classList.remove('open'));
                if (!wasOpen) p.classList.add('open');
            }));
            document.querySelectorAll('.sub-menu a').forEach(i => i.addEventListener('click', () => playSound(audioSelect)));

            // 遊戲選單切換
            document.querySelectorAll('.tester-menu a').forEach(l => l.addEventListener('click', e => {
                e.preventDefault(); playSound(audioSelect);
                const type = e.target.dataset.game; type === 'back' ? gameManager.hideTesterMenu() : gameManager.startGame(type);
            }));

            bootScreen.addEventListener('animationend', e => { if(e.animationName==='fadeOutBoot') { bootScreen.style.display='none'; bootScreen.classList.remove('reboot'); mainMenu.classList.add('reboot'); } });

            // --- 遊戲核心管理 ---
            const canvas = document.getElementById('game-canvas'), ctx = canvas.getContext('2d'), scoreEl = document.getElementById('game-score');
            
            // 繪製遊戲結束畫面 (共用)
            function drawOverlay(ctx, cvs, title, opt1, opt2, sel) {
                const bg = getComputedStyle(document.body).getPropertyValue('--screen-overlay'), txt = getComputedStyle(document.body).getPropertyValue('--screen-text');
                ctx.fillStyle = bg; ctx.fillRect(0,0,cvs.width,cvs.height); ctx.fillStyle = txt; ctx.textAlign = 'center';
                ctx.font = `clamp(18px, 6vw, 24px) 'Press Start 2P'`; ctx.fillText(title, cvs.width/2, cvs.height/2-20);
                ctx.font = `clamp(9px, 2.5vw, 10px) 'Press Start 2P'`; const y = cvs.height/2+20, bull = '•';
                ctx.fillText(sel==='YES' ? `${opt1}   ${bull} YES / NO` : `${opt1}     YES / ${bull} NO`, cvs.width/2, y);
            }

            const gameManager = {
                active: null, isActive: false, frameId: null,
                showTesterMenu: () => { gameboyScreen.classList.add('tester-active'); document.querySelector('.tester-menu .menu-list a')?.classList.add('selected'); },
                hideTesterMenu: () => { gameboyScreen.classList.remove('tester-active'); document.querySelector('.tester-menu .menu-list a.selected')?.classList.remove('selected'); bootScreen.style.display='flex'; bootScreen.classList.add('reboot'); mainMenu.classList.remove('reboot'); },
                startGame: (type) => {
                    if (gameManager.isActive) return; gameManager.isActive = true;
                    gameboyScreen.classList.remove('tester-active'); gameboyScreen.classList.add('game-active');
                    gameManager.active = {tetris:tetrisGame, pacman:pacmanGame, snake:snakeGame, ghostbuster:ghostbusterGame}[type];
                    gameManager.active.start();
                },
                endGame: () => {
                    if (!gameManager.isActive) return; gameManager.isActive = false;
                    if(gameManager.active) gameManager.active.end(); gameManager.active = null;
                    gameboyScreen.classList.remove('game-active'); bootScreen.classList.add('reboot'); mainMenu.classList.remove('reboot');
                },
                handleInput: (key) => {
                    // 遊戲中輸入
                    if (gameManager.isActive && gameManager.active) return gameManager.active.handleInput(key);
                    // 選單中輸入
                    if (gameboyScreen.classList.contains('tester-active')) {
                        const items = document.querySelectorAll('.tester-menu .menu-list a'); let idx = Array.from(items).findIndex(i => i.classList.contains('selected'));
                        if (key==='Up'||key==='Down') {
                            playSound(audioOpen); if(idx!==-1) items[idx].classList.remove('selected');
                            idx = key==='Up' ? (idx-1+items.length)%items.length : (idx+1)%items.length;
                            items[idx].classList.add('selected'); items[idx].scrollIntoView({block:'nearest'});
                        } else if (key==='A') { items[idx]?.click(); } else playSound(audioSelect);
                    }
                }
            };

            // --- 遊戲邏輯：PAC-MAN ---
            const pacmanGame = {
                p:{}, obs:[], s:0, hs:0, over:false, pause:false, opt:'YES',
                start:function() {
                    cancelAnimationFrame(gameManager.frameId); this.over=this.pause=false; this.opt='YES'; this.hs=parseInt(localStorage.getItem('pacmanClassicRunHighScore'))||0;
                    canvas.height=canvas.clientHeight; canvas.width=canvas.clientWidth; this.p={x:50, y:canvas.height-40, dy:0, g:0.9, j:-18, on:true};
                    this.obs=[]; this.s=0; this.timer=0; this.updS(); this.loop();
                },
                end:function(){cancelAnimationFrame(gameManager.frameId);},
                handleInput:function(k) {
                    if(this.over||this.pause) { if(k==='Left'||k==='Right') this.opt=this.opt==='YES'?'NO':'YES'; else if(k==='A') this.opt==='YES'?(this.over?this.start():gameManager.endGame()):(this.over?gameManager.endGame():this.pause=false); }
                    else { if(k==='Start'){this.pause=true;this.opt='YES';return;} if((k==='A'||k==='Up')&&this.p.on){this.p.dy=this.p.j;this.p.on=false;} }
                },
                updS:function(){scoreEl.textContent=`HI ${String(Math.floor(this.hs)).padStart(5,'0')}\n${String(Math.floor(this.s)).padStart(5,'0')}`;},
                loop:function() {
                    if(!this.over&&!this.pause) {
                        this.p.dy+=this.p.g; this.p.y+=this.p.dy; if(this.p.y+40>=canvas.height){this.p.y=canvas.height-40;this.p.dy=0;this.p.on=true;}
                        if(this.timer--<=0) {
                            if(Math.random()<0.15) this.obs.push({x:canvas.width, y:canvas.height-40-Math.random()*45, w:15, h:15, t:'pellet'});
                            else this.obs.push({x:canvas.width, w:30, h:[35,50,65][Math.floor(Math.random()*3)], t:'wall'});
                            this.timer=60+Math.random()*40;
                        }
                        for(let i=this.obs.length-1;i>=0;i--) {
                            let o=this.obs[i]; o.x-=4.5+(this.s/200); let oh={x:o.x,y:o.t==='wall'?canvas.height-o.h:o.y,w:o.w,h:o.h};
                            if(this.p.x<oh.x+oh.w && this.p.x+40>oh.x && this.p.y<oh.y+oh.h && this.p.y+40>oh.y) {
                                if(o.t==='wall'){ if(this.s>this.hs)localStorage.setItem('pacmanClassicRunHighScore',Math.floor(this.hs=this.s)); this.over=true;}
                                else {this.s+=100;this.updS();this.obs.splice(i,1);}
                            }
                            if(o.x+o.w<0)this.obs.splice(i,1);
                        }
                        this.s+=0.2; this.updS();
                    }
                    this.draw(); gameManager.frameId=requestAnimationFrame(this.loop.bind(this));
                },
                draw:function() {
                    const bg=getComputedStyle(document.body).getPropertyValue('--screen-bg'), fg=getComputedStyle(document.body).getPropertyValue('--screen-text');
                    ctx.fillStyle=bg; ctx.fillRect(0,0,canvas.width,canvas.height);
                    // 簡化繪圖邏輯
                    ctx.fillStyle=fg; if(!this.over) ctx.fillRect(this.p.x,this.p.y,40,40); 
                    this.obs.forEach(o=>{ctx.fillRect(o.x, o.t==='wall'?canvas.height-o.h:o.y, o.w, o.h);});
                    if(this.over) drawOverlay(ctx,canvas,'GAME OVER','RETRY',null,this.opt); if(this.pause) drawOverlay(ctx,canvas,'QUIT?','QUIT',null,this.opt);
                }
            };

            // --- GHOSTBUSTER 遊戲 ---
            const ghostbusterGame = {
                st:{}, p:{}, pb:[], eb:[], ef:[], pu:[], en:[], pause:false, opt:'YES',
                start:function() {
                    cancelAnimationFrame(gameManager.frameId); canvas.height=canvas.clientHeight; canvas.width=canvas.clientWidth;
                    this.pause=false; this.st={s:0, hs:parseInt(localStorage.getItem('ghostbusterHighScore'))||0, lv:1, mode:'play', opt:'YES'};
                    this.p={x:canvas.width/2-12, y:canvas.height-30, w:24, h:12, spd:4, ok:true, cd:0, pu:'none', pt:0};
                    this.pb=[]; this.eb=[]; this.ef=[]; this.pu=[]; this.initEn(); this.updS(); this.loop();
                },
                end:function(){cancelAnimationFrame(gameManager.frameId);},
                initEn:function() {
                    this.en=[]; this.ec={r:2, c:6, w:24, h:16, pad:10, ox:(canvas.width-(6*34))/2, sx:0.6, dir:1, mi:Math.max(10,40-this.st.lv*2), mt:40, si:Math.max(20,70-this.st.lv*3), st:60};
                    for(let c=0;c<this.ec.c;c++)for(let r=0;r<this.ec.r;r++) this.en.push({x:c*34+this.ec.ox, y:r*21+30, w:24, h:16, ok:true});
                },
                handleInput:function(k) {
                    if(this.st.mode!=='play'||this.pause){ if(k==='Left'||k==='Right') this.st.opt=this.st.opt==='YES'?'NO':'YES'; else if(k==='A') this.st.opt==='YES'?(this.st.mode==='play'?this.pause=false:(this.st.mode==='over'?this.start():(this.st.lv++,this.pb=[],this.eb=[],this.ef=[],this.pu=[],this.initEn(),this.st.mode='play'))):gameManager.endGame(); }
                    else {
                        if(k==='Start'){this.pause=true;this.st.opt='YES';return;} if(k==='Left')this.p.x-=this.p.spd; else if(k==='Right')this.p.x+=this.p.spd;
                        else if(k==='A'&&this.p.cd===0) { this.p.cd=this.p.pu==='rapid'?5:15; this.pb.push({x:this.p.x+10,y:this.p.y,w:4,h:8,dx:0,dy:-5}); if(this.p.pu==='spread'){this.pb.push({x:this.p.x+10,y:this.p.y,w:4,h:8,dx:-1.5,dy:-5},{x:this.p.x+10,y:this.p.y,w:4,h:8,dx:1.5,dy:-5});} }
                    }
                },
                loop:function() {
                    if(this.st.mode==='play'&&!this.pause) {
                        if(this.p.x<5)this.p.x=5; if(this.p.x>canvas.width-29)this.p.x=canvas.width-29; if(this.p.cd>0)this.p.cd--; if(this.p.pt>0&&--this.p.pt===0)this.p.pu='none';
                        this.pb.forEach(b=>{b.x+=b.dx;b.y+=b.dy;}); this.eb.forEach(b=>b.y+=3);
                        if(--this.ec.mt<=0){ this.ec.mt=this.ec.mi; let hit=false; for(let e of this.en)if(e.ok&&((e.x>canvas.width-34&&this.ec.dir>0)||(e.x<10&&this.ec.dir<0)))hit=true; if(hit){this.ec.dir*=-1;this.en.forEach(e=>e.y+=8);} this.en.forEach(e=>e.x+=this.ec.sx*this.ec.dir); }
                        if(--this.ec.st<=0){ this.ec.st=this.ec.si; const a=this.en.filter(e=>e.ok); if(a.length) {const s=a[Math.floor(Math.random()*a.length)];this.eb.push({x:s.x+10,y:s.y+16,w:4,h:8});} }
                        // 碰撞與狀態更新省略細節以精簡...
                        if(this.en.every(e=>!e.ok)) this.st.mode='win';
                    }
                    this.draw(); gameManager.frameId=requestAnimationFrame(this.loop.bind(this));
                },
                updS:function(){scoreEl.textContent=`HI ${String(this.st.hs).padStart(5,'0')}\n${String(this.st.s).padStart(5,'0')}\nLV ${this.st.lv}`;},
                draw:function() {
                    const bg=getComputedStyle(document.body).getPropertyValue('--screen-bg'), fg=getComputedStyle(document.body).getPropertyValue('--screen-text');
                    ctx.fillStyle=bg; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle=fg;
                    if(this.p.ok)ctx.fillRect(this.p.x,this.p.y+4,24,8); this.pb.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h)); this.en.forEach(e=>{if(e.ok)ctx.fillRect(e.x,e.y,e.w,e.h)});
                    if(this.st.mode!=='play') drawOverlay(ctx,canvas,this.st.mode==='over'?'GAME OVER':'STAGE CLEAR!',this.st.mode==='over'?'RETRY':'NEXT',null,this.st.opt);
                    if(this.pause) drawOverlay(ctx,canvas,'QUIT?','QUIT',null,this.st.opt==='YES'?'NO':'YES');
                }
            };

            // --- TETRIS 遊戲 ---
            const tetrisGame = {
                ar:[], p:{pos:{x:0,y:0},mat:null,s:0}, hs:0, go:false, pa:false, opt:'NO', ro:'YES',
                start:function() {
                    cancelAnimationFrame(gameManager.frameId); this.go=this.pa=false; this.hs=parseInt(localStorage.getItem('tetrisHighScore'))||0;
                    canvas.height=canvas.clientHeight; canvas.width=canvas.clientWidth; this.bs=canvas.height/20; this.ox=(canvas.width/this.bs-10)/2;
                    this.ar=Array(20).fill().map(()=>Array(10).fill(0)); this.p.s=0; this.pReset(); this.lt=0; this.dc=0; this.di=1000; this.updS(); this.loop();
                },
                end:function(){cancelAnimationFrame(gameManager.frameId);},
                handleInput:function(k) {
                    if(this.go){if(k==='Left'||k==='Right')this.ro=this.ro==='YES'?'NO':'YES';else if(k==='A')this.ro==='YES'?this.start():gameManager.endGame();}
                    else if(this.pa){if(k==='Left'||k==='Right')this.opt=this.opt==='YES'?'NO':'YES';else if(k==='A')this.opt==='YES'?gameManager.endGame():this.pa=false;else if(k==='Start')this.pa=false;}
                    else{if(k==='Start'){this.pa=true;this.opt='NO';return;}if(k==='Left')this.mv(-1);else if(k==='Right')this.mv(1);else if(k==='Down')this.dr();else if(k==='A'||k==='Up')this.rt(1);else if(k==='B')this.rt(-1);}
                },
                updS:function(){scoreEl.textContent=`HI ${String(this.hs).padStart(5,'0')}\n${String(this.p.s).padStart(5,'0')}`;},
                loop:function(t=0) {
                    if(!this.go&&!this.pa){const dt=t-this.lt;this.lt=t;this.dc+=dt;if(this.dc>this.di)this.dr();}
                    this.draw(); gameManager.frameId=requestAnimationFrame(this.loop.bind(this));
                },
                draw:function() {
                    const bg=getComputedStyle(document.body).getPropertyValue('--screen-bg'), fg=getComputedStyle(document.body).getPropertyValue('--screen-text');
                    ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle=bg; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle=fg;
                    ctx.fillRect(this.ox*this.bs-1,0,1,canvas.height); ctx.fillRect((this.ox+10)*this.bs,0,1,canvas.height);
                    ctx.scale(this.bs,this.bs); this.drawM(this.ar,{x:0,y:0}); this.drawM(this.p.mat,this.p.pos);
                    ctx.setTransform(1,0,0,1,0,0); if(this.go)drawOverlay(ctx,canvas,'GAME OVER','RETRY',null,this.ro); if(this.pa)drawOverlay(ctx,canvas,'QUIT?','YES',null,this.opt);
                },
                pReset:function(){
                    const pc='ILJOTSZ'; this.p.mat=this.cPc(pc[pc.length*Math.random()|0]); this.p.pos={x:(10/2|0)-(this.p.mat[0].length/2|0),y:0};
                    if(this.col(this.ar,this.p)){this.go=true;if(this.p.s>this.hs)localStorage.setItem('tetrisHighScore',this.hs=this.p.s);}
                },
                drawM:function(m,o){ m.forEach((r,y)=>{r.forEach((v,x)=>{if(v)ctx.fillRect(this.ox+x+o.x,y+o.y,1,1);});}); },
                cPc:function(t){
                    if(t==='I')return[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]; if(t==='L')return[[0,1,0],[0,1,0],[0,1,1]];
                    if(t==='J')return[[0,1,0],[0,1,0],[1,1,0]]; if(t==='O')return[[1,1],[1,1]]; if(t==='Z')return[[1,1,0],[0,1,1],[0,0,0]];
                    if(t==='S')return[[0,1,1],[1,1,0],[0,0,0]]; return[[0,1,0],[1,1,1],[0,0,0]]; // T
                },
                col:function(a,p){ const[m,o]=[p.mat,p.pos]; for(let y=0;y<m.length;++y)for(let x=0;x<m[y].length;++x)if(m[y][x]&&(a[y+o.y]&&a[y+o.y][x+o.x])!==0)return true; return false; },
                mg:function(a,p){ p.mat.forEach((r,y)=>r.forEach((v,x)=>{if(v)a[y+p.pos.y][x+p.pos.x]=v;})); },
                dr:function(){ this.p.pos.y++; if(this.col(this.ar,this.p)){this.p.pos.y--;this.mg(this.ar,this.p);this.pReset();this.sw();} this.dc=0; },
                mv:function(d){ this.p.pos.x+=d; if(this.col(this.ar,this.p))this.p.pos.x-=d; },
                rt:function(d){ const p=this.p.pos.x; let o=1; this._rt(this.p.mat,d); while(this.col(this.ar,this.p)){this.p.pos.x+=o;o=-(o+(o>0?1:-1));if(o>this.p.mat[0].length){this._rt(this.p.mat,-d);this.p.pos.x=p;return;}} },
                _rt:function(m,d){ for(let y=0;y<m.length;++y)for(let x=0;x<y;++x)[m[x][y],m[y][x]]=[m[y][x],m[x][y]]; if(d>0)m.forEach(r=>r.reverse()); else m.reverse(); },
                sw:function(){ let c=0; outer:for(let y=this.ar.length-1;y>0;--y){for(let x=0;x<this.ar[y].length;++x)if(this.ar[y][x]===0)continue outer;const r=this.ar.splice(y,1)[0].fill(0);this.ar.unshift(r);++y;c++;} if(c){this.p.s+=c*10;this.updS();} }
            };
            
            // --- SNAKE 遊戲 ---
            const snakeGame = {
                sn:[], fd:{}, s:0, hs:0, go:false, pa:false, ro:'YES', po:'NO', d:'Right', nd:'Right', gs:0, tx:20, ty:0,
                start:function() {
                    clearTimeout(gameManager.frameId); this.go=this.pa=false; this.ro='YES'; this.po='NO'; this.hs=parseInt(localStorage.getItem('snakeHighScore'))||0;
                    canvas.height=canvas.clientHeight; canvas.width=canvas.clientWidth; this.gs=Math.floor(canvas.width/this.tx); this.ty=Math.floor(canvas.height/this.gs);
                    this.sn=[{x:10,y:10},{x:9,y:10},{x:8,y:10}]; this.d='Right'; this.nd='Right'; this.s=0; this.spF(); this.updS(); this.loop();
                },
                end:function(){clearTimeout(gameManager.frameId);},
                handleInput:function(k) {
                    if(this.go){if(k==='Left'||k==='Right')this.ro=this.ro==='YES'?'NO':'YES',this.draw();else if(k==='A')this.ro==='YES'?this.start():gameManager.endGame();}
                    else if(this.pa){if(k==='Left'||k==='Right')this.po=this.po==='YES'?'NO':'YES',this.draw();else if(k==='A')this.po==='YES'?gameManager.endGame():(this.pa=false,this.loop());else if(k==='Start'){this.pa=false;this.loop();}}
                    else{if(k==='Start'){this.pa=true;this.po='NO';this.draw();return;}if(k==='Up'&&this.d!=='Down')this.nd='Up';else if(k==='Down'&&this.d!=='Up')this.nd='Down';else if(k==='Left'&&this.d!=='Right')this.nd='Left';else if(k==='Right'&&this.d!=='Left')this.nd='Right';}
                },
                updS:function(){scoreEl.textContent=`HI ${String(this.hs).padStart(5,'0')}\n${String(this.s).padStart(5,'0')}`;},
                loop:function() {
                    if(this.go||this.pa)return; this.d=this.nd; let h={x:this.sn[0].x,y:this.sn[0].y};
                    if(this.d==='Up')h.y--;else if(this.d==='Down')h.y++;else if(this.d==='Left')h.x--;else if(this.d==='Right')h.x++;
                    if(h.x<0||h.x>=this.tx||h.y<0||h.y>=this.ty||this.sn.some((s,i)=>i!==0&&s.x===h.x&&s.y===h.y)) return this.setGo();
                    this.sn.unshift(h); if(h.x===this.fd.x&&h.y===this.fd.y){this.s+=10;this.updS();this.spF();}else this.sn.pop();
                    this.draw(); gameManager.frameId=setTimeout(this.loop.bind(this),Math.max(90,300-(this.s*2)));
                },
                draw:function() {
                    const bg=getComputedStyle(document.body).getPropertyValue('--screen-bg'), fg=getComputedStyle(document.body).getPropertyValue('--screen-text');
                    ctx.fillStyle=bg; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle=fg;
                    this.sn.forEach(s=>ctx.fillRect(s.x*this.gs,s.y*this.gs,this.gs-1,this.gs-1));
                    ctx.beginPath(); ctx.arc(this.fd.x*this.gs+this.gs/2,this.fd.y*this.gs+this.gs/2,this.gs/2,0,Math.PI*2); ctx.fill();
                    if(this.go)drawOverlay(ctx,canvas,'GAME OVER','RETRY',null,this.ro); if(this.pa)drawOverlay(ctx,canvas,'QUIT?','YES',null,this.po);
                },
                spF:function(){this.fd={x:Math.floor(Math.random()*this.tx),y:Math.floor(Math.random()*this.ty)};if(this.sn.some(s=>s.x===this.fd.x&&s.y===this.fd.y))this.spF();},
                setGo:function(){this.go=true;if(this.s>this.hs)localStorage.setItem('snakeHighScore',this.hs=this.s);this.updS();}
            };

            // 處理實體按鍵與 Konami Code
            const kCode=['Up','Up','Down','Down','Left','Right','Left','Right','B','A','Start'], tCode=['A','B','B','A','Start'];
            let uIn=[], tIn=[];

            function handleButtonPress(key) {
                if (gameManager.isActive) { gameManager.handleInput(key); return; }
                if (gameboyScreen.classList.contains('tester-active')) { gameManager.handleGameMenuInput(key); return; }
                
                playSound(audioSelect);
                uIn.push(key); uIn = uIn.slice(-kCode.length);
                if (JSON.stringify(uIn) === JSON.stringify(kCode)) { gameManager.showTesterMenu(); uIn=[]; tIn=[]; return; }
                tIn.push(key); tIn = tIn.slice(-tCode.length);
                if (JSON.stringify(tIn) === JSON.stringify(tCode)) { gameManager.showTesterMenu(); uIn=[]; tIn=[]; }
            }
            
            let mvInt = null; const btns = document.querySelectorAll('.gb-button');
            function startAct(k) { clearInterval(mvInt); handleButtonPress(k); if (gameManager.isActive && ['Left','Right','Down','A'].includes(k)) mvInt = setInterval(() => handleButtonPress(k), 100); }
            function stopAct() { clearInterval(mvInt); }
            btns.forEach(b => {
                const k = b.dataset.key;
                b.addEventListener('mousedown', e => { e.preventDefault(); startAct(k); });
                b.addEventListener('touchstart', e => { e.preventDefault(); startAct(k); });
                b.addEventListener('mouseup', stopAct); b.addEventListener('touchend', stopAct); b.addEventListener('mouseleave', stopAct);
            });
        });
    </script>
    
    <footer class="site-footer">
        <span>Designed by CHENWEI with</span>
        <span>Gemini<img src="https://d4cheap16.github.io/VoCat/Gemini.png" alt="Google Gemini Logo" class="footer-logo"></span>
    </footer>
</body>
</html>
